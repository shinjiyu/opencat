<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>OpenCat Chat</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  :root { --bg: #f7f7f8; --chat-bg: #fff; --user-bg: #e3f2fd; --bot-bg: #f5f5f5; --accent: #1976d2; --text: #1a1a1a; --muted: #666; --border: #e0e0e0; }
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); height: 100dvh; display: flex; flex-direction: column; }
  .header { padding: 12px 20px; background: var(--chat-bg); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
  .header h1 { font-size: 18px; font-weight: 600; }
  .header .status { font-size: 12px; color: var(--muted); }
  .messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; }
  .msg { max-width: 80%; padding: 12px 16px; border-radius: 12px; line-height: 1.6; white-space: pre-wrap; word-break: break-word; }
  .msg.user { align-self: flex-end; background: var(--user-bg); border-bottom-right-radius: 4px; }
  .msg.bot { align-self: flex-start; background: var(--bot-bg); border-bottom-left-radius: 4px; }
  .msg.error { align-self: center; background: #ffebee; color: #c62828; font-size: 14px; text-align: center; }
  .msg.system { align-self: center; color: var(--muted); font-size: 14px; text-align: center; background: none; }
  .input-area { padding: 12px 20px; background: var(--chat-bg); border-top: 1px solid var(--border); display: flex; gap: 10px; }
  .input-area textarea { flex: 1; padding: 10px 14px; border: 1px solid var(--border); border-radius: 8px; font-size: 15px; resize: none; font-family: inherit; outline: none; min-height: 44px; max-height: 120px; }
  .input-area textarea:focus { border-color: var(--accent); }
  .input-area button { padding: 0 20px; background: var(--accent); color: #fff; border: none; border-radius: 8px; font-size: 15px; cursor: pointer; white-space: nowrap; }
  .input-area button:disabled { opacity: 0.5; cursor: not-allowed; }
  .no-token { display: flex; align-items: center; justify-content: center; height: 100%; padding: 40px; text-align: center; }
  .no-token p { font-size: 16px; color: var(--muted); line-height: 1.8; }
</style>
</head>
<body>

<div class="header">
  <h1>OpenCat Chat</h1>
  <span class="status" id="status"></span>
</div>

<div class="messages" id="messages"></div>

<div class="input-area">
  <textarea id="input" rows="1" placeholder="输入消息..." disabled></textarea>
  <button id="send" disabled>发送</button>
</div>

<script>
const TOKEN = new URLSearchParams(location.search).get("token");
// Detect path prefix: if page is at /opencat/chat, API is at /opencat/v1/...
const pathPrefix = location.pathname.replace(/\/chat\/?$/, "");
const BASE = location.origin + pathPrefix;

const messagesEl = document.getElementById("messages");
const inputEl = document.getElementById("input");
const sendBtn = document.getElementById("send");
const statusEl = document.getElementById("status");

const chatHistory = [];

if (!TOKEN) {
  messagesEl.innerHTML = '<div class="no-token"><p>未检测到 Token。<br>请从安装包中打开聊天链接，或在 URL 中添加 ?token=xxx</p></div>';
} else {
  inputEl.disabled = false;
  sendBtn.disabled = false;
  statusEl.textContent = "就绪";
  addMsg("system", "连接成功，开始聊天吧！");
}

sendBtn.addEventListener("click", send);
inputEl.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); send(); }
});

// Auto-resize textarea
inputEl.addEventListener("input", () => {
  inputEl.style.height = "auto";
  inputEl.style.height = Math.min(inputEl.scrollHeight, 120) + "px";
});

async function send() {
  const text = inputEl.value.trim();
  if (!text || sendBtn.disabled) return;

  addMsg("user", text);
  chatHistory.push({ role: "user", content: text });
  inputEl.value = "";
  inputEl.style.height = "auto";
  sendBtn.disabled = true;
  statusEl.textContent = "思考中...";

  const botEl = addMsg("bot", "");

  try {
    const res = await fetch(BASE + "/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer " + TOKEN,
      },
      body: JSON.stringify({
        model: "auto",
        messages: chatHistory,
        stream: true,
      }),
    });

    if (!res.ok) {
      const err = await res.json().catch(() => ({ error: { message: res.statusText } }));
      botEl.textContent = "错误: " + (err.error?.message || res.statusText);
      botEl.className = "msg error";
      statusEl.textContent = "错误";
      sendBtn.disabled = false;
      return;
    }

    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let fullContent = "";
    let buffer = "";

    while (true) {
      const { value, done } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split("\n");
      buffer = lines.pop() || "";

      for (const line of lines) {
        const trimmed = line.trim();
        if (!trimmed || !trimmed.startsWith("data: ")) continue;
        const data = trimmed.slice(6);
        if (data === "[DONE]") continue;

        try {
          const parsed = JSON.parse(data);
          const delta = parsed.choices?.[0]?.delta?.content;
          if (delta) {
            fullContent += delta;
            botEl.textContent = fullContent;
            messagesEl.scrollTop = messagesEl.scrollHeight;
          }
        } catch {}
      }
    }

    chatHistory.push({ role: "assistant", content: fullContent });
    statusEl.textContent = "就绪";
  } catch (err) {
    botEl.textContent = "网络错误: " + err.message;
    botEl.className = "msg error";
    statusEl.textContent = "错误";
  }

  sendBtn.disabled = false;
  inputEl.focus();
}

function addMsg(role, text) {
  const el = document.createElement("div");
  el.className = "msg " + role;
  el.textContent = text;
  messagesEl.appendChild(el);
  messagesEl.scrollTop = messagesEl.scrollHeight;
  return el;
}
</script>
</body>
</html>
